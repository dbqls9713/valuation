name: cli-smoke

on:
  workflow_dispatch:
    inputs:
      run_codex:
        description: "Run Codex CLI smoke test"
        required: false
        default: "false"
      codex_auth_mode:
        description: "auth_json or api_key"
        required: false
        default: "auth_json"

jobs:
  gemini_cli_smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Gemini CLI
        run: npm i -g @google/gemini-cli

      - name: Write GCP service account key
        shell: bash
        run: |
          mkdir -p .secrets
          # JSON을 안전하게 파일로 저장 (멀티라인 대응)
          printf '%s' '${{ secrets.GCP_SA_KEY_JSON }}' > .secrets/sa.json

      - name: Gemini CLI (Vertex) smoke test
        shell: bash
        env:
          GOOGLE_GENAI_USE_VERTEXAI: "true"
          GOOGLE_APPLICATION_CREDENTIALS: "${{ github.workspace }}/.secrets/sa.json"
          GOOGLE_CLOUD_PROJECT: "${{ secrets.GCP_PROJECT_ID }}"
          GOOGLE_CLOUD_LOCATION: "${{ secrets.GCP_LOCATION }}"
        run: |
          gemini --prompt "Say ok" --output-format json | tee gemini_out.json
          # jq는 ubuntu-latest에 기본 포함인 경우가 많지만, 없으면 설치
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          jq -e '.response | ascii_downcase | contains("ok")' gemini_out.json >/dev/null
          echo "Gemini CLI OK"

  codex_cli_smoke:
    runs-on: ubuntu-latest
    # 입력값으로만 분기 (secrets 존재 여부로 분기하지 않음)
    if: ${{ github.event.inputs.run_codex == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Codex CLI
        run: npm i -g @openai/codex

      - name: Configure Codex auth (auth.json) - raw JSON
        shell: bash
        run: |
          set -euo pipefail
          export CODEX_HOME="${{ github.workspace }}/.codex"
          mkdir -p "$CODEX_HOME"

          # IMPORTANT: EOF must start at column 1 (no indentation)
          cat > "$CODEX_HOME/auth.json" <<'EOF'
${{ secrets.CODEX_AUTH_JSON }}
EOF

          chmod 600 "$CODEX_HOME/auth.json"
          echo "CODEX_HOME=$CODEX_HOME" >> $GITHUB_ENV

      - name: Codex CLI smoke test (auth.json)
        if: ${{ github.event.inputs.codex_auth_mode == 'auth_json' }}
        shell: bash
        run: |
          set -euo pipefail
          codex exec "Say ok" | tee codex_out.txt
          grep -iq "ok" codex_out.txt
          echo "Codex CLI OK (auth.json)"
